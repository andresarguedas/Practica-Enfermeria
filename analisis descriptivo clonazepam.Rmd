---
title: "Análisis descriptivo clonazepam"
author: "Andrés E. Arguedas L."
date: ''
output:
  html_document: default
  pdf_document: default
number_sections: yes
---

***

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
x <- c("ggplot2", "scales", "gridExtra", "grid", "magrittr", "plyr", "cowplot", "lubridate", "knitr")
sapply(x, library, character.only = T)
remove(x)
clon <- readRDS(file = paste(getwd(), "/data/clonazepam.rds", sep = ""))
clon$edad.rec <- cut(clon$edad, breaks = c(-Inf, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, Inf), labels = c("0 a 10", "11 a 15", "16 a 20", "21 a 25", "26 a 30", "31 a 35", "36 a 40", "41 a 45", "46 a 50", "51 a 55", "56 a 60", "61 a 65", "66 a 70", "71 a 75", "76 a 80", "81 a 85", "86 a 90", "Más de 91"))
clon.na <- na.omit(clon)
theme1 <- theme(axis.text.x = element_text(size = 11 * 0.8), axis.text.y = element_text(size = 11 * 0.8), axis.title.x = element_text(size = 11), axis.title.y = element_text(size = 11), plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
fuente1 <- "Fuente: Datos de consumo de psicotrópicos de la CCSS del 2011 al 2015"
i <- 0
```

  Las prescripciones de clonazepam tomadas en cuenta para este análisis son todas aquellas emitidas entre enero del `r min(clon$año)` y diciembre del `r max(clon$año)`, lo que equivale a un total de `r nrow(clon)` prescripciones emitidas en este período. Las variables de interés de las prescripciones son la dosis y la frecuencia, es decir, la cantidad de pastillas o gotas que la persona toma en un día y la cantidad de veces en las cuales toma el medicamento. El problema con la obtención de las variables anteriores es que estas no se encuentran de forma explícita en los datos, sino que se deben extraer de la indicación médica correspondiente. Por lo anterior, se desarrolló un algoritmo capaz de extraer las variables de interés de estas indicaciones de forma bastante exacta.
  
  Teniendo la dosis para cada prescripción, se procede a transformar esta en la cantidad de miligramos de medicina que la persona toma al día, para así poder comparar entre las dos presentaciones del medicamento. Posteriormente, se asignó un identificador único por persona, tomando en cuenta tanto su número de cédula como su nombre, pudiendo obtener resultados más precisos. Adicionalmente, se analizaron ciertos casos extremos y datos con errores, por lo que, para el posterior análisis, se terminó con un total de `r nrow(clon.na)` prescripciones.

```{r Pastel, fig.pos = 'p'}
mujeres <- sum(clon.na$sexo == 2) / nrow(clon.na)
hombres <- sum(clon.na$sexo == 1) / nrow(clon.na)

df1 <- data.frame(
  sexo = c("Hombres", "Mujeres"),
  porcentaje = c(hombres, mujeres)
)

bp <- ggplot(df1, aes(x = "", y = porcentaje, fill = sexo)) + geom_bar(width = 1, stat = "identity")
pie <- bp + coord_polar("y", start = 0)

blank_theme <- theme_minimal()+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )

i <- i + 1

pie <- pie + scale_fill_manual(values = c("brown2", "blue3"), name = "Sexo") +  blank_theme +
  theme(axis.text.x=element_blank(), plot.title = element_text(hjust = 0.5)) +
  geom_text(aes(y = c(cumsum(porcentaje)[-length(porcentaje)] + .5, cumsum(porcentaje)[-length(porcentaje)]), 
            label = percent(porcentaje)), size=5) + ggtitle(paste("Figura ", i, ":\nPorcentaje del total de prescripciones de clonazepam por sexo,\n en Costa Rica, entre el 2011 y el 2015", sep = ""))

g1 <- arrangeGrob(pie, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g1)
```

```{r Paciente, fig.pos = 'p'}
clon.na$sexo %<>% as.numeric()
clon.paciente <- aggregate(x = clon.na[, c(3, 5, 18)], by = list(ID = clon.na$ID), FUN = function(x) c(m = min(x), l = length(x), sum(x > 8)))
clon.na$sexo %<>% factor()
clon.paciente$sexo <- clon.paciente$sexo[, 1]
clon.paciente$prescripciones <- clon.paciente$edad[, 2]
clon.paciente$edad <- clon.paciente$edad[, 1]
clon.paciente$mg <- clon.paciente$mg[, 3]
clon.paciente$edad.rec <- cut(clon.paciente$edad, breaks = c(-Inf, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, Inf), labels = c("0 a 10", "11 a 15", "16 a 20", "21 a 25", "26 a 30", "31 a 35", "36 a 40", "41 a 45", "46 a 50", "51 a 55", "56 a 60", "61 a 65", "66 a 70", "71 a 75", "76 a 80", "81 a 85", "86 a 90", "Más de 91"))
clon.ddd <- subset(clon.paciente, mg >= 1)
```

  De la Figura `r i` se puede observar que la mayor cantidad de prescripciones son dadas a mujeres, las cuales representan un `r round(sum(clon.paciente$sexo == 2) / nrow(clon.paciente) * 100, 2)`% del total de pacientes, por lo que hay congruencia entre la cantidad de mujeres y la cantidad de prescripciones recetadas a mujeres. Esto parece indicar que, por lo menos en términos del promedio de prescripciones entre hombres y mujeres, no van a haber diferencias tan notables entre hombres y mujeres, relativamente.

```{r Prescripciones por edad, fig.pos = 'p'}
clon.edad <- aggregate(clon.na$mg, by = list(Edad = clon.na$edad.rec), FUN = function(x) c(length(x), mean(x), sum(x > 8)))
clon.edad$promedio <- clon.edad$x[, 2]
clon.edad$ddd <- clon.edad$x[, 3]
clon.edad$x <- clon.edad$x[, 1]
clon.edad$ddd.p <- clon.edad$ddd / clon.edad$x * 100

i <- i + 1

barras <- ggplot(data = clon.edad, aes(x = Edad, y = x)) + 
  geom_col(fill = "brown") + 
  ylab("Prescripciones") +
  ggtitle(paste("Figura ", i, ":\nCantidad de prescripciones de clonazepam por grupos de edad,\n en Costa Rica, entre el 2011 y el 2015", sep = "")) +
  theme1 +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5))

g3 <- arrangeGrob(barras, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g3)
```

  Cabe resaltar, con base en la Figura `r i`, que no se da una gran acumulación de prescripciones en un grupo etario en específico, aunque parece haber una pequeña asimetría hacia la derecha, lo que indica que hay una mayor acumulación de prescripciones en edades mayores. De igual forma, hay una gran cantidad de prescripciones para personas entre 46 y 65 años, lo que equivale a un `r round(sum(clon.edad$x[9:12])/701795, 2) * 100`% del total de prescripciones. Adicionalmente, parece que el crecimiento en la cantidad de prescripciones al aumentar la edad es más precipitado que el descenso al aumentar la edad.

```{r Piramide, warning = F, fig.pos = 'p'}
clon.sexoedad <- aggregate(x = clon.na, by = list(Edad = clon.na$edad.rec, Sexo = clon.na$sexo), FUN = length)[, 1:3]
clon.sexoedad$ID <- ifelse(clon.sexoedad$Sexo == 1, clon.sexoedad$ID / 237900 * 100, clon.sexoedad$ID / 463895 * 100)
clon.sexoedad$ID <- ifelse(clon.sexoedad$Sexo == 1, -1 * clon.sexoedad$ID, clon.sexoedad$ID)
colnames(clon.sexoedad)[3] <- "Prescripciones"

i <- i + 1

piramide <- ggplot(clon.sexoedad, aes(x = Edad, y = Prescripciones, fill = Sexo)) + 
                   geom_bar(subset = .(Sexo == 1), stat = "identity") +
                   geom_bar(subset = .(Sexo == 2), stat = "identity") +
                   coord_flip() +
                   theme1+
                   theme(panel.grid.minor.y=element_blank(),
                         panel.grid.major.y=element_blank()) +
                   scale_fill_brewer(palette = "Set1", labels = c("Hombres", "Mujeres")) +
                   scale_y_continuous(limits = c(-12.5, 12.5), breaks = seq(-10, 10, 5), 
                                      labels = c("10", "5", "0", "5", "10")) +
                   xlab("Edad") +
                   ylab("Porcentaje") +
                   ggtitle(paste("Figura ", i, ":\nPorcentaje del total de prescripciones de clonazepam por grupos de edad\n y sexo, en Costa Rica, entre el 2011 y el 2015", sep = ""))
                   

g2 <- arrangeGrob(piramide, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g2)
```

  Al separar tanto por sexo como por grupos etarios, se puede ver, de la Figura `r i`, que aunque la distribución porcentual de las prescripciones es parecida tanto para hombres como para mujeres, en el caso de las mujeres parece haber un porcentaje mayor de prescripciones para personas entre los 46 y 65 años, lo que es consistente con lo observado en la Figura `r i - 1`. Es importante señalar que en la Figura `r i` se usó un porcentaje por sexo dado que, por lo visto en la Figura `r i - 2`, hay una cantidad considerablemente mayor de prescripciones a mujeres que hombres, por lo que si se separan los datos absolutos se vuelve difícil ver la distribución de estos, lo que dificulta el análisis.

```{r Media por edad, message = F, fig.pos = 'p'}
i <- i + 1

media.edad <- ggplot(data = clon.edad, aes(x = Edad, y = promedio, group = 1)) + 
  geom_point(size = 2.5) + 
  geom_line() + 
  ylab("Dosis promedio (en mg)") +
  ggtitle(paste("Figura ", i, ":\nDosis diaria promedio, en miligramos, por grupos de edad,\n en Costa Rica, entre el 2011 y el 2015", sep = "")) +
  theme1 +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5))

g4 <- arrangeGrob(media.edad, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g4)
```

  Es importante resaltar que la dosis diaria promedio de clonazepam durante el período de estudio es de `r round(mean(clon.na$mg), 2)` mg. Ahora, la dosis diaria promedio, dividida por sexo, es de `r round(mean(clon.na$mg[clon.na$sexo == 1]), 2)` mg para hombres y de `r round(mean(clon.na$mg[clon.na$sexo == 2]), 2)` mg para mujeres, por lo que se puede notar que no hay diferencias importantes en la dosis promedio entre los dos sexos. En la Figura `r i` se puede notar que se da un aumento notable en la dosis promedio durante las edades más tempranas, para luego estabilizarse y aumentar levemente después de los 21 años. Luego, la máxima dosis promedio se encuentra entre las personas de 46 a 50 años, presentando un decrecimiento bastante importante posterior a este rango de edad. Comparando estos resultados con los de la Figura `r i - 2`, el crecimiento en la cantidad de prescripciones se da a un ritmo más lento que el crecimiento de la dosis promedio, por lo que, en edades más tempranas, aunque se da una menor cantidad de prescripciones, la cantidad de miligramos de medicamento es muy parecida a la medicada a edades mayores. Por otro lado, el decrecimiento en la dosis promedio es parecido al decrecimiento presente en la cantidad de prescripciones, por lo que se puede decir que, en edades mayores, se da una menor cantidad de prescripciones de clonazepam y estas, en promedio, corresponden a una cantidad menor de medicamento.
  
```{r Serie de tiempo, message = F, error = F, fig.pos = 'p'}
clon.tiempo <- aggregate(x = clon.na[, 1], by = list(Mes = clon.na$mes, Año = clon.na$año), FUN = length)
clon.tiempo$tiempo <- ymd(paste(clon.tiempo$Año, clon.tiempo$Mes, 1))

i <- i + 1

serie.tiempo <- ggplot(data = clon.tiempo, aes(x = tiempo, y = x)) + 
  geom_line() + 
  ylab("Cantidad de prescripciones") + 
  xlab("Año") + 
  theme1 +
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  ggtitle(paste("Figura ", i, ":\nCantidad de prescripciones de clonazepam por mes y año,\n en Costa Rica, entre el 2011 y el 2015", sep = ""))

g5 <- arrangeGrob(serie.tiempo, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g5)
```

  Al ver la cantidad de prescripciones por mes y año, presentadas en la Figura `r i`, hay una tendencia creciente en la cantidad de prescripciones a lo largo del tiempo. Cabe resaltar el pico presente hacia finales del 2011, que parece ser el valor más raro de toda la serie temporal. Además, hay aumentos pronunciados a mediados del 2013 y a lo largo del 2014, pero, durante el 2015, parece que el crecimiento se ha estabilizado un poco.

#Pacientes y prescripciones mayores a la DDD

  Es importante notar que, para el caso de clonazepam, la dosis diaria definida (DDD) es de 8 mg, lo que significa que una dosis mayor a 8 mg puede ser peligrosa, por lo que es de interés investigar este tipo de prescripciones. Ahora, de un total de `r nrow(clon.paciente)` pacientes, sólo `r nrow(clon.ddd)`, equivalente a un `r round(nrow(clon.ddd)/nrow(clon.paciente) * 100, 2)`% del total, recibieron al menos una prescripción mayor a la DDD. Además, un `r round(sum(clon.ddd$prescripciones) / 701795 * 100, 2)`% del total de prescripciones fueron dadas con dosis mayores a la DDD, lo que indica que hay pacientes que están recibiendo consistentemente dosis mayores a la recomendada. Relacionado a lo anterior, un `r round(sum(clon.ddd$mg > 1) / nrow(clon.ddd) * 100, 2)`% de los pacientes con al menos una prescripcion mayor a la DDD tienen más de una prescripción de este tipo. Estos pacientes, en total, tienen un `r round(sum(clon.ddd$mg[clon.ddd$mg > 1]) / sum(clon.ddd$mg) * 100, 2)`% del total de prescripciones mayores a la DDD, lo que significa que hay una aglomeración considerable de prescripciones mayores a la DDD en unos pocos pacientes.
  
```{r Edad DDD}
i <- i + 1

barras.ddd <- ggplot(data = clon.ddd, aes(x = edad.rec, y = mg)) +
                     geom_col(fill = "brown") + 
                     ylab("Prescripciones") +
                     xlab("Edad") +
                     ggtitle(paste("Figura ", i, ":\nCantidad de prescripciones de clonazepam por encima de la DDD\n por grupos de edad, en Costa Rica, entre el 2011 y el 2015", sep = "")) +
                     theme1 +
                     theme(axis.text.x = element_text(angle = 70, vjust = 0.5))

g8 <- arrangeGrob(barras.ddd, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g8)
```
  
  Según la Figura `r i`, no parece haber una distribución muy clara de las prescripciones por encima de la DDD según los grupos de edad. Aun así, parece haber una concentración importante de prescripciones entre los 51 y 65 años de edad. Por último, se nota que hay pocas de estas prescripciones en edades avanzadas, pero en edades jovenes si parece haber una cantidad considerable de prescripciones con dosis por encima de la DDD.
  
```{r Dispersion DDD}
i <- i + 1

dispersion <- ggplot(data = clon.ddd, aes(x = clon.ddd$mg, y = clon.ddd$prescripciones)) +
              geom_point() +
              geom_jitter() +
              geom_abline(slope = 1, intercept = 0, colour = 2) +
              theme1 +
              xlab("Cantidad de prescripciones mayores a la DDD") +
              ylab("Cantidad de prescripciones") +
              ggtitle(paste("Figura ", i, ":\nCantidad de prescripciones totales y mayores a la DDD por paciente,\n en Costa Rica, entre el 2011 y el 2015\n(La línea roja representa que la totalidad de \nprescripciones son mayores a la DDD)", sep = ""))

g9 <- arrangeGrob(dispersion, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g9)
```

  Ahora, con respecto a la Figura `r i`, la línea roja se refiere al punto en el cual la cantidad de prescripciones del paciente es igual a la cantidad de prescripciones por con dosis por encima de la DDD; es decir, puntos sobre la línea roja han tenido todas sus prescripciones por encima de la DDD. Como se puede notar, hay una cantidad considerable de puntos cercanos a la línea roja, sobre todo si solo tomamos en cuenta aquellas personas que tienen una cantidad alta de prescripciones por encima de la DDD, esto parece indicar que las personas con una cantidad alta de dosis por encima de la DDD han recibido la totalidad de sus prescripciones de esa forma. Luego, en los pacientes con una alta cantidad de prescripciones recetadas se puede ver que casi no hay prescripciones por encima de la DDD.
  
# Médicos

```{r Medico}
clon.medico <- aggregate(x = clon.na$mg, by = list(Medico = clon.na$medico), FUN = function(x) c(length(x), sum(x > 8)))
clon.medico$ddd <- clon.medico$x[, 2]
clon.medico$x <- clon.medico$x[, 1]
```

  El análisis por médico se enfoca en identificar la relación entre la cantidad de prescripciones emitidas y la cantidad de médicos que las rectaron. Lo anterior se hace con el objetivo de ver si existen médicos que aglomeran un porcentaje importante del total de prescripciones. Además, se busca ver cuántos médicos han recetado por encima de la DDD y cuántas veces lo han hecho, para determinar si hay médicos que consistentemente recetan por encima de la DDD. Es importante mencionar que un total de `r nrow(clon.medico)` médicos dieron al menos una prescripción de clonazepam durante el período de estudio, todo esto dentro de la CCSS.

```{r Porcentaje de medicos}
u1 <- unique(clon.medico$x)
u1 <- u1[order(u1)]

v1 <- matrix(nrow = length(u1), ncol = 2)

for(l in 1:length(u1)) {
  v1[l, 1] <- sum(clon.medico$x > u1[l]) / nrow(clon.medico) * 100
  v1[l, 2] <- sum(clon.medico$x[clon.medico$x > u1[l]]) / nrow(clon.na) * 100
}

v1 %<>% as.data.frame()

i <- i + 1

medicos.por <- ggplot(data = v1, aes(x = V1, y = V2)) + 
               geom_line() +
               xlab("Porcentaje de médicos") +
               ylab("Porcentaje de prescripciones emitidas") +
               theme1 +
               ggtitle(paste("Figura ", i, ":\nPorcentaje de prescripciones de clonazepam emitidas por un cierto\n porcentaje de médicos, en Costa Rica, entre el 2011 y el 2015", sep = ""))

g6 <- arrangeGrob(medicos.por, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g6)
```

  Con base en la Figura `r i`, se puede notar que un porcentaje bastante pequeño de los médicos receta la gran mayoría de las recetas de clonazepam. Por ejemplo, un `r round(v1[10, 1], 0)`% de los médicos recetan el `r round(v1[10, 2], 2)`% del total de prescripciones, mientras que un `r round(v1[52, 1], 0)`% de los médicos recetan un `r round(v1[52, 2], 2)`%. De igual forma es importante resaltar que un `r round(v1[403, 2], 2)`% de todas las prescripciones son recetadas por un `r round(v1[403, 1], 3)`% de los médicos, aproximadamente `r round(nrow(clon.medico) * v1[403, 1] / 100, 0)` médicos. Lo anterior demuestra que hay una cantidad bastante pequeña de médicos que dan la mayoría de prescripciones de clonazepam del país.

```{r Medicos con DDD}
i <- i + 1

dispersion.m <- ggplot(data = clon.medico, aes(x = clon.medico$ddd, y = clon.medico$x)) +
              geom_point() +
              geom_jitter() +
              theme1 +
              xlab("Cantidad de prescripciones mayores a la DDD") +
              ylab("Cantidad de prescripciones") +
              geom_abline(slope = 1, intercept = 0, colour = 2) +
              ggtitle(paste("Figura ", i, ":\nCantidad de prescripciones total y mayores a la DDD recetadas\n según médico, en Costa Rica, entre el 2011 y el 2017\n(La línea roja representa que la totalidad de \nprescripciones son mayores a la DDD)", sep = ""))

g7 <- arrangeGrob(dispersion.m, bottom = textGrob(fuente1, x = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10)))

grid.draw(g7)
```

  Es importante resaltar que un `r round(sum(clon.medico$ddd > 1) / nrow(clon.medico) * 100, 2)`% de los médicos hicieron al menos una prescripción con una dosis mayor a la DDD. Ahora, con respecto a la Figura `r i`, podemos notar que hay un caso extremo que ha hecho más de 400 prescripciones mayores a la DDD, pero, sin contar el caso anterior, todos los médicos han recetado menos de 100 prescripciones con una dosis mayor a la DDD. También vale la pena resaltar que, comparando los resultados de la anterior figura con los de la Figura `r i - 1`, hay una cantidad considerable de médicos que han dado más de 2500 recetas de clonazepam en el período de estudio. Lo anterior equivale, en promedio, a `r round(2500 / 60, 2)` recetas de clonazepam mensuales, en otras palabras, más de una receta de clonazepam diaria. En el caso del médico que recetó cerca de 12000 prescripciones, esto equivale a seis y media recetas de clonazepam diarias, en promedio.

# Especialidad

```{r Especialidad}
clon.especialidad <- aggregate(x = clon.na$mg, by = list(Especialidad = clon.na$especialidad), FUN = function(x) c(length(x), sum(x > 8)))

clon.especialidad$ddd <- clon.especialidad$x[, 2]
clon.especialidad$x <- clon.especialidad$x[, 1]

options(scipen = 5)

clon.especialidad$porcentaje <- clon.especialidad$x / 701795 * 100
clon.especialidad$porcentaje.ddd <- clon.especialidad$ddd / clon.especialidad$x * 100
clon.especialidad[49, ] <- c("Otros", sum(clon.especialidad$x[-c(22, 44)]), sum(clon.especialidad$ddd[-c(22, 44)]), sum(clon.especialidad$porcentaje[-c(22, 44)]), 0)
clon.especialidad$porcentaje %<>% as.numeric()
clon.especialidad$x %<>% as.numeric()
clon.especialidad$ddd %<>% as.numeric()
clon.especialidad$porcentaje.ddd %<>% as.numeric()
clon.especialidad1 <- clon.especialidad[c(22, 44, 49), ]
clon.especialidad1$Especialidad %<>% tolower()
clon.especialidad1$porcentaje %<>% as.numeric()
clon.especialidad1$porcentaje %<>% round(., 2)
clon.especialidad1$x %<>% as.numeric()
```

  En el análisis por especialidad es de interés determinar cuales son las especialidades con mayor cantidad de prescripciones de clonazepam recetadas. De igual forma, en el caso de las prescripciones con dosis mayor a la DDD, es importante determinar si hay alguna especialidad en específico que esté recetando un porcentaje mayor de este tipo de prescripciones con respecto a las demás.

|Especialidad | Cantidad de prescripciones | Porcentaje del total|
|:---|---:|---:|
|General | `r clon.especialidad1$x[1]` | `r clon.especialidad1$porcentaje[1]`%|
|Psiquiatría | `r clon.especialidad1$x[2]` | `r clon.especialidad1$porcentaje[2]`%|
|Otros |`r clon.especialidad1$x[3]` | `r clon.especialidad1$porcentaje[3]`%|
|**Total** |**`r sum(clon.especialidad1$x)`** |**`r sum(clon.especialidad1$porcentaje)`** |

Table: **Tabla 1: Cantidad total y porcentual de prescripciones de clonazepam por especialidad médica, en Costa Rica, entre el 2011 y el 2015.**

  Con base en la Tabla 1, se puede observar que la especialidad en la cual se receta la mayor cantidad de prescripciones de clonazepam es Medicina General, seguido por Psiquiatría, mientras que las demás especialidades tienen una cantidad considerablemente menor de prescripciones, sin que ninguna supere más del 3% de prescripciones. 
  
  Ahora, analizando las especialidades según la DDD, aunque la mayor cantidad de prescripciones con dosis por encima de la DDD se dan en Medicina General y Psiquiatría (`r clon.especialidad$ddd[22]` y `r clon.especialidad$ddd[44]` prescripciones, respectivamente), esto nada más equivale a un `r round(clon.especialidad$porcentaje.ddd[22], 2)`% y `r round(clon.especialidad$porcentaje.ddd[44], 2)`%, respectivamente, del total de prescripciones de estas dos especialidades. Aun así, cabe mencionar que en esas dos especialidades se concentra el `r round((clon.especialidad$ddd[22] + clon.especialidad$ddd[44]) / sum(clon.na$mg > 8) * 100, 2)`% del total de las prescripciones por encima de la DDD. Las dos especialidades con los porcentajes más altos de prescripciones con dosis por encima de la DDD son neurología y reumatología, con un `r round(clon.especialidad$porcentaje.ddd[32], 2)`% y `r round(clon.especialidad$porcentaje.ddd[47], 2)`%, respectivamente.

# Área de salud

```{r Area de salud}
clon.unidad <- aggregate(x = clon.na$mg, by = list(Unidad = clon.na$unidad.ejecutora), FUN = function(x) c(length(x), mean(x), sum(x > 8)))
clon.unidad$promedio <- clon.unidad$x[, 2]
clon.unidad$ddd <- clon.unidad$x[, 3]
clon.unidad$x <- clon.unidad$x[, 1]
clon.unidad$porcentaje <- clon.unidad$x / 701795 * 100
clon.unidad$ddd.porcentaje <- clon.unidad$ddd / clon.unidad$x * 100
```

  En el caso del análisis por áreas de salud, interesa determinar la cantidad de prescripciones por cada área de salud, además de aquellas cuya dosis exceda el DDD. 
  
|Área de salud |Cantidad de prescripciones | Porcentaje del total |
|:---|---:|---:|
|Hospital Rafael Ángel Calderón Guardia |`r clon.unidad$x[1]` |`r round(clon.unidad$porcentaje[1], 2)`% |
|Hospital Nacional Psiquiátrico |`r clon.unidad$x[36]` |`r round(clon.unidad$porcentaje[36], 2)`% |
|Área de Salud de Coronado |`r clon.unidad$x[17]` |`r round(clon.unidad$porcentaje[17], 2)`% |
|Hospital San Vicente Paúl |`r clon.unidad$x[11]` |`r round(clon.unidad$porcentaje[11], 2)`% |
|Otros |`r sum(clon.unidad$x[-c(1, 36, 17, 11)])` |`r round(sum(clon.unidad$porcentaje[-c(1, 36, 17, 11)]), 2)`% |
|**Total** |**`r sum(clon.unidad$x)`** |**`r sum(clon.unidad$porcentaje)`** |
  
Table: **Tabla 2: Cantidad total y porcentual de prescripciones de clonazepam por área de salud, en Costa Rica, entre el 2011 y el 2015.**
  
  Con base en la Tabla 2, las cuatro áreas de salud que más prescripciones dan son el Hospital Rafael Ángel Calderón Guardia, el Hospital Nacional Psiquiátrico, el Área de Salud de Coronado y el Hospital San Vicente de Paúl, con un `r round(clon.unidad$porcentaje[1], 2)`%, `r round(clon.unidad$porcentaje[36], 2)`%, `r round(clon.unidad$porcentaje[17], 2)`% y un `r round(clon.unidad$porcentaje[11], 2)`% del total de prescripciones, respectivamente. En el caso del Hospital Nacional Psiquiátrico, dado lo visto en el análisis por especialidad, se podía esperar que esta institución presentara un alto porcentaje de prescripciones, dado que se trata de una institución con un alto porcentaje de psiquiatras. De igual forma, en el Hospital Rafael Ángel Calderón Guardia, dado el tamaño de este centro y la cantidad de personal médico que tiene, era un buen candidato para ser de los centros médicos con mayor porcentaje de prescripciones.
  
  Con respecto a las prescripciones con dosis por encima de la DDD, hay cuatro áreas de salud que tienen un porcentaje de este tipo de prescripciones mayores al 2%, estas son el Hospital Nacional de Niños, el Área de Salud de Nicoya, el Área de Salud de la Cruz y el Hospital de Golfito, con un `r round(clon.unidad$ddd.porcentaje[3], 2)`%, `r round(clon.unidad$ddd.porcentaje[78], 2)`%, `r round(clon.unidad$ddd.porcentaje[84], 2)`% y `r round(clon.unidad$ddd.porcentaje[105], 2)`%, respectivamente. Cabe resaltar que tres de estas cuatro unidades son de fuera del Valle Central y tres de los primeros seis lugares son hospitales. Adicionalmente, en un `r round(sum(clon.unidad$ddd == 0) / nrow(clon.unidad), 2)`% de las unidades no se prescribió ninguna receta con dosis mayor a la DDD.